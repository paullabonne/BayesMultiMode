---
title: "testing the estimation of continuous mixtures using stan"
output: html_document
---

# Load package
```{r}
# install.packages("rstan", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
library(BayesMultiMode)
```


# Data

## Galaxy data
```{r}
y = multimode::galaxyrg

plot(density(y), type="l")
```

```{r}
out = gibbsSFM_normal(y,
                5,
                2000)

for (i in 1:5){
  plot(out[,i], type="l")
}

plot(out[,16], type = "l")
```


## Fish data
```{r}
data("fish", package = "bayesmix")
y = unlist(fish)
plot(density(y), type="l")
```

## Darwin data
```{r}
data("darwin", package = "bayesmix")
y = unlist(darwin)
plot(density(y), type="l")
```

## Pen world data
```{r}
library(dplyr)
library(pwt10)

df_pwt_60 = pwt10.0 %>%
  select(year,country,rgdpe) %>%
  filter(year %in% rep(1960:1969, 1)) %>%
  group_by(country) %>%
  summarise(rgdpe = as.numeric(mean(rgdpe, na.rm=T)/1000))

df_pwt_70 = pwt10::pwt10.0 %>%
  select(year,country,rgdpe) %>%
  filter(year %in% rep(1970:1979,1)) %>%
  group_by(country) %>%
  summarise(rgdpe = as.numeric(mean(rgdpe, na.rm=T)/1000))

df_pwt_80 = pwt10::pwt10.0 %>%
  select(year,country,rgdpe) %>%
  filter(year %in% rep(1980:1989,1)) %>%
  group_by(country) %>%
  summarise(rgdpe = as.numeric(mean(rgdpe, na.rm=T)/1000))

df_pwt_90 = pwt10::pwt10.0 %>%
  select(year,country,rgdpe) %>%
  filter(year %in% rep(1990:1999,1)) %>%
  group_by(country) %>%
  summarise(rgdpe = as.numeric(mean(rgdpe, na.rm=T)/1000))

df_pwt_00 = pwt10::pwt10.0 %>%
  select(year,country,rgdpe) %>%
  filter(year %in% rep(2000:2009,1)) %>%
  group_by(country) %>%
  summarise(rgdpe = as.numeric(mean(rgdpe, na.rm=T)/1000))

df_pwt_10 = pwt10::pwt10.0 %>%
  select(year,country,rgdpe) %>%
  filter(year %in% rep(2010:2019,1)) %>%
  group_by(country) %>%
  summarise(rgdpe = as.numeric(mean(rgdpe, na.rm=T)/1000))

y = unlist(df_pwt_90$rgdpe[!is.na(df_pwt_90$rgdpe)])
y = y
hist(y, breaks = 100)
```

## Normal draws
```{r, eval = FALSE}
mu = c(0.5,2,4)
sigma = c(0.3,0.4,0.2)
p = c(0.3,0.5,0.2)
nb_draws = 200

y = c(rnorm(nb_draws*p[1], mu[1], sigma[1]),
      rnorm(nb_draws*p[2], mu[2], sigma[2]),
      rnorm(nb_draws*p[3], mu[3], sigma[3]))

hist(y,main = "Simulated data", breaks=100)
```

## Student t draws
```{r}
N = 500
y = c(sn::rst(0.3*N, xi = 2, omega = 0.5, nu = 2),
      sn::rst(0.7*N, xi = 10, omega = 1, nu = Inf))

hist(y, breaks = 100)
plot(density(y), type="l")
```

## Skew normal draws
The skew normal density of Azzalini takes the form 
$$f(x, \mu, \sigma, \alpha) = \frac{2}{\sigma}\phi(\frac{x-\mu}{\sigma})\Phi(\alpha \frac{x-\mu}{\sigma}),$$ 
where $\sigma \in R^+$ is a scale parameter, $\mu \in R$ a location parameter $\alpha \in R$ the shape or asymmetry parameter. The functions $\phi(.)$ and $\Phi(.)$ are the density and cumulative functions of the normal distribution.
```{r}
N = 200
y = c(rsn(0.6*N, 0, 1, 20),rsn(0.4*N, 3, 0.5, 0))

hist(y, breaks = 100)
```

## Skew t draws
```{r}
N = 70
y = c(sn::rst(0.7*N, xi = 0, omega = 1, alpha = 20, nu= 2),
      sn::rst(0.3*N, xi = 5, omega = 0.5, alpha = 0, nu= Inf))

hist(y, breaks = 100)
```

## DNA data
```{r}
data("d4z4")
y = d4z4

p1 = 0.5
p2 = 1-p1
kap1 = 10
kap2 = 0
lam1 = 1
lam2 = 0.1
length_data = 70
y <- c(rpois(length_data*p1, lam1)+kap1, rpois(length_data*p2, lam2)+kap2)

y = multimode::geyser

y = y[1:70]
hist(y)
```

# Bayesian estimation
```{r, message =FALSE, warning=FALSE}
K = 2
# y = y/1000
dist = "normal"
hist(y)
bayesmix = bayes_estimation(data = y, K = K,
                            dist = dist,
                            nb_iter = 2000)

plot(bayesmix, max_size = 500, transparency = 0.2)
```

# convergence
```{r}
# for (i in 1:length(wesanderson::wes_palettes)){
#   scales::show_col(unlist(wesanderson::wes_palettes[i]))
# }
library(magrittr)
model_var = bayesmix$pars_names

mcmc = posterior::as_draws_df(bayesmix$fit)
mcmc %<>% dplyr::select(-tidyr::contains("sigmaSQ"))
# mcmc[is.na(mcmc)] = 0
theme_p <- ggplot2::theme_minimal()
bayesplot::bayesplot_theme_set(theme_p)
j=15
col = c(wesanderson::wes_palettes[[j]], wesanderson::wes_palettes[[j]][2])
bayesplot::color_scheme_set(scheme = col[1:6])
for (par in model_var){
 show(bayesplot::mcmc_trace(mcmc,
                 pars = colnames(mcmc)[grep(par,colnames(mcmc))])) 
}

mcmc %>%
  tidyr::gather(-.chain, -.iteration, -.draw, key = "var", value = "value") %>%
  dplyr::group_by(.chain, var) %>%
  dplyr::summarise(rhat = posterior::rhat(value)) %>%
  tidyr::spread(key = "var", value = "rhat") %>%
  dplyr::select(lp__) %>%
  dplyr::ungroup() %>%
  dplyr::select(-.chain)
```

# Mode estimation
```{r}
modes = bayes_mode(bayesmix, rd=1)
plot(modes)
```

## illustration using ten iterations
```{r}
modes = t(apply(mcmc_output_post[1:10,], 1, MEM, plots=T))
```

